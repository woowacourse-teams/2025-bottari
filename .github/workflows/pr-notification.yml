name: BE PR Review & Merge Notification

on:
  pull_request_review:
    branches:
      - be/develop
    types: [submitted] # ë¦¬ë·° ì œì¶œ ì‹œ
  pull_request:
    branches:
      - be/develop
    types: [closed]    # PR ë¨¸ì§€/ë‹«íž˜ ì‹œ

jobs:
  pr-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Determine Webhook
        run: echo "WEBHOOK=${{ secrets.DISCORD_BACKEND_WEBHOOK }}" >> $GITHUB_ENV

      # ---------------------------
      # 1. ë¦¬ë·° ì œì¶œ ì‹œ
      # ---------------------------
      # ë¦¬ë·° ì œì¶œ ì‹œ
      - name: Notify Discord - Review Submitted
        if: github.event_name == 'pull_request_review'
        run: |
          AUTHOR=${{ github.event.pull_request.user.login }}
          AUTHOR_ID=$(echo '${{ secrets.DISCORD_USER_MAP }}' | jq -r --arg AUTHOR "$AUTHOR" '.[$AUTHOR]')
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH=${{ github.event.pull_request.head.ref }}

          MESSAGE='{
            "content": "<@'"$AUTHOR_ID"'> ðŸ“ ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.",
            "embeds": [
              {
                "title": "ë¦¬ë·° ë“±ë¡",
                "url": "'"${{ github.event.pull_request.html_url }}"'",
                "color": 3447003,
                "fields": [
                  { "name": "PR ì œëª©", "value": "'"${{ github.event.pull_request.title }}"'" },
                  { "name": "ë¸Œëžœì¹˜", "value": "'"$HEAD_BRANCH â†’ $BASE_BRANCH"'" },
                  { "name": "ë¦¬ë·° ìƒíƒœ", "value": "'"${{ github.event.review.state }}"'" }
                ]
              }
            ]
          }'
          echo "$MESSAGE" > payload.json
          curl -H "Content-Type: application/json" -d @payload.json $WEBHOOK

      # ---------------------------
      # 2. PR ë¨¸ì§€/ë‹«íž˜ ì‹œ
      # ---------------------------
      - name: Notify Discord - PR Closed/Merged
        if: github.event_name == 'pull_request'
        run: |
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH=${{ github.event.pull_request.head.ref }}

          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            STATUS="ðŸŽ‰ PR ë¨¸ì§€ ì™„ë£Œ"
            COLOR=16766720
          else
            STATUS="âš ï¸ PR ë‹«íž˜ (ë¨¸ì§€ ì•ˆë¨)"
            COLOR=15105570
          fi

          MESSAGE='{
            "embeds": [
              {
                "title": "'"$STATUS"'",
                "url": "'"${{ github.event.pull_request.html_url }}"'",
                "color": '$COLOR',
                "fields": [
                  { "name": "PR ì œëª©", "value": "'"${{ github.event.pull_request.title }}"'" },
                  { "name": "ë¸Œëžœì¹˜", "value": "'"$HEAD_BRANCH â†’ $BASE_BRANCH"'" },
                  { "name": "ìž‘ì„±ìž", "value": "'"${{ github.event.pull_request.user.login }}"'" }
                ]
              }
            ]
          }'
          echo "$MESSAGE" > payload.json
          curl -H "Content-Type: application/json" -d @payload.json $WEBHOOK
