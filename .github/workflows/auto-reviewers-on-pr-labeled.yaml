name: Label Based Review Assign

on:
  pull_request:
    types: [labeled]

jobs:
  assign-reviewers-by-label:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    steps:
      - name: Assign reviewers by label
        uses: actions/github-script@v7
        with:
          script: |
            const androidReviewers = ['moondev03', 'Leeyerin0210', 'cucumber99'];
            const backendReviewers = ['Sung-june27', 'YehyeokBang', 'jaehyeon2650', 'unh6unh6'];
            const allReviewers = [...new Set([...androidReviewers, ...backendReviewers])];

            const labelToReviewers = {
              'ðŸ¤– Android': androidReviewers,
              'ðŸ’» Backend': backendReviewers,
              'ðŸŒ All': allReviewers
            };

            const pr = context.payload.pull_request;
            const currentUser = pr.user.login;
            const labels = pr.labels.map(label => label.name.toLowerCase().trim());

            const { owner, repo } = context.repo;
            const pull_number = pr.number;

            let reviewersToAssign = [];
            for (const label of labels) {
              if (labelToReviewers[label]) {
                reviewersToAssign = labelToReviewers[label];
                break;
              }
            }

            reviewersToAssign = reviewersToAssign.filter(r => r !== currentUser);

            const currentReviewersRes = await github.rest.pulls.listRequestedReviewers({
              owner,
              repo,
              pull_number
            });

            const currentReviewers = currentReviewersRes.data.users.map(u => u.login);

            const reviewersToRemove = currentReviewers.filter(r => !reviewersToAssign.includes(r));
            const reviewersToAdd = reviewersToAssign.filter(r => !currentReviewers.includes(r));

            if (reviewersToRemove.length > 0) {
              await github.rest.pulls.removeRequestedReviewers({
                owner,
                repo,
                pull_number,
                reviewers: reviewersToRemove
              });
            }

            if (reviewersToAdd.length > 0) {
              await github.rest.pulls.requestReviewers({
                owner,
                repo,
                pull_number,
                reviewers: reviewersToAdd
              });
            }
