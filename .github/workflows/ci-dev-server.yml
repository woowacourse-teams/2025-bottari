name: BE PR CI & NOTIFICATION

on:
  pull_request:
    branches:
      - be/develop
    types: [ opened, synchronize, reopened, closed ]
  pull_request_review:
    types: [ submitted ]

jobs:
  ci-and-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Grant Execute Permission for Gradlew
        run: chmod +x ./backend/bottari/gradlew

      # ë¼ë²¨ ê¸°ë°˜ Webhook ê²°ì •
      - name: Determine Webhook
        id: webhook
        run: |
          echo "WEBHOOK=${{ secrets.DISCORD_BACKEND_WEBHOOK }}" >> $GITHUB_ENV

      - name: Build and Test
        id: test
        run: ./gradlew clean build --no-daemon
        continue-on-error: true

      # í…ŒìŠ¤íŠ¸ ì„±ê³µ ì‹œ ë¦¬ë·°ì–´ë§Œ ë©˜ì…˜
      - name: Notify Discord (Test Success)
        if: success()
        run: |
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH=${{ github.event.pull_request.head.ref }}

          # ë¦¬ë·°ì–´ ë©˜ì…˜ & ë¦¬ìŠ¤íŠ¸ ìƒì„±
          REVIEWERS=$(jq -r '.pull_request.requested_reviewers[].login' <<< '${{ toJson(github.event) }}')
          MENTIONS=""
          REVIEWER_NAMES=""
          for r in $REVIEWERS; do
            ID=$(echo '${{ secrets.DISCORD_USER_MAP }}' | jq -r --arg r "$r" '.[$r]')
            if [ "$ID" != "null" ]; then
              MENTIONS="$MENTIONS <@$ID>"
              if [ -z "$REVIEWER_NAMES" ]; then
                REVIEWER_NAMES="$r"
              else
                REVIEWER_NAMES="$REVIEWER_NAMES, $r"
              fi
            fi
          done

          if [ -z "$MENTIONS" ]; then
            MENTIONS="ë¦¬ë·°ì–´ê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi

          MESSAGE='{
            "content": "'"$MENTIONS"' í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤. ì½”ë“œ ë¦¬ë·° ë¶€íƒë“œë¦½ë‹ˆë‹¤!",
            "embeds": [
              {
                "title": "âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ - ë¦¬ë·° ìš”ì²­",
                "description": "í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ PR ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",
                "url": "'"${{ github.event.pull_request.html_url }}"'",
                "color": 65280,
                "fields": [
                  { "name": "PR ì œëª©", "value": "'"${{ github.event.pull_request.title }}"'" },
                  { "name": "ë¸Œëœì¹˜", "value": "'"$HEAD_BRANCH â†’ $BASE_BRANCH"'" },
                  { "name": "ì‘ì„±ì", "value": "'"${{ github.event.pull_request.user.login }}"'" },
                  { "name": "ë¦¬ë·°ì–´", "value": "'"$REVIEWER_NAMES"'" }
                ]
              }
            ]
          }'
          echo "$MESSAGE" > payload.json
          curl -H "Content-Type: application/json" -d @payload.json $WEBHOOK

      # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ PR ì‘ì„±ìë§Œ ë©˜ì…˜ + ë¡œê·¸ ë§í¬
      - name: Notify Discord (Test Failure)
        if: failure()
        run: |
          AUTHOR=${{ github.event.pull_request.user.login }}
          AUTHOR_ID=$(echo '${{ secrets.DISCORD_USER_MAP }}' | jq -r --arg AUTHOR "$AUTHOR" '.[$AUTHOR]')
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH=${{ github.event.pull_request.head.ref }}
          LOG_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          MESSAGE='{
            "content": "<@'"$AUTHOR_ID"'> í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. PRì„ í™•ì¸í•´ì£¼ì„¸ìš”!",
            "embeds": [
              {
                "title": "âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨",
                "description": "í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. [ë¡œê·¸ í™•ì¸í•˜ê¸°]('"$LOG_URL"')",
                "url": "'"${{ github.event.pull_request.html_url }}"'",
                "color": 16711680,
                "fields": [
                  { "name": "PR ì œëª©", "value": "'"${{ github.event.pull_request.title }}"'" },
                  { "name": "ë¸Œëœì¹˜", "value": "'"$HEAD_BRANCH â†’ $BASE_BRANCH"'" },
                  { "name": "ì‘ì„±ì", "value": "'"$AUTHOR"'" }
                ]
              }
            ]
          }'
          echo "$MESSAGE" > payload.json
          curl -H "Content-Type: application/json" -d @payload.json $WEBHOOK

      # ë¦¬ë·°ê°€ ë‹¬ë¦¬ë©´ PR ì‘ì„±ì ë©˜ì…˜
      - name: Notify Discord - Review
        if: github.event_name == 'pull_request_review'
        run: |
          AUTHOR=${{ github.event.pull_request.user.login }}
          AUTHOR_ID=$(echo '${{ secrets.DISCORD_USER_MAP }}' | jq -r --arg AUTHOR "$AUTHOR" '.[$AUTHOR]')
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH=${{ github.event.pull_request.head.ref }}

          MESSAGE='{
            "content": "<@'"$AUTHOR_ID"'> ğŸ“ ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!",
            "embeds": [
              {
                "title": "ë¦¬ë·° ë“±ë¡",
                "description": "'"${{ github.event.review.body }}"'",
                "url": "'"${{ github.event.pull_request.html_url }}"'",
                "color": 3447003,
                "fields": [
                  { "name": "PR ì œëª©", "value": "'"${{ github.event.pull_request.title }}"'" },
                  { "name": "ë¸Œëœì¹˜", "value": "'"$HEAD_BRANCH â†’ $BASE_BRANCH"'" },
                  { "name": "ë¦¬ë·° ìƒíƒœ", "value": "'"${{ github.event.review.state }}"'" }
                ]
              }
            ]
          }'
          echo "$MESSAGE" > payload.json
          curl -H "Content-Type: application/json" -d @payload.json $WEBHOOK

      # PR ë‹«í˜/ë¨¸ì§€ ì•Œë¦¼
      - name: Notify Discord - PR Closed/Merged
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        run: |
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH=${{ github.event.pull_request.head.ref }}

          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            STATUS="ğŸ‰ PR ë¨¸ì§€ ì™„ë£Œ"
            COLOR=16766720 # ê¸ˆìƒ‰ (#FFD700)
          else
            STATUS="âš ï¸ PR ë‹«í˜ (ë¨¸ì§€ ì•ˆë¨)"
            COLOR=15105570
          fi

          MESSAGE='{
            "embeds": [
              {
                "title": "'"$STATUS"'",
                "url": "'"${{ github.event.pull_request.html_url }}"'",
                "color": '$COLOR',
                "fields": [
                  { "name": "PR ì œëª©", "value": "'"${{ github.event.pull_request.title }}"'" },
                  { "name": "ë¸Œëœì¹˜", "value": "'"$HEAD_BRANCH â†’ $BASE_BRANCH"'" },
                  { "name": "ì‘ì„±ì", "value": "'"${{ github.event.pull_request.user.login }}"'" }
                ]
              }
            ]
          }'
          echo "$MESSAGE" > payload.json
          curl -H "Content-Type: application/json" -d @payload.json $WEBHOOK
